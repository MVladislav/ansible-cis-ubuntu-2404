---
# tasks file for ansible-cis-ubuntu-2404

# ------------------------------------------------------------------------------

- name: "SECTION6 | 6.1.1.1 | Ensure journald service is enabled and active"
  ansible.builtin.systemd_service:
    name: systemd-journald.service
    daemon_reload: true
    enabled: true
    masked: false
    state: started
  when:
    - cis_ubuntu2404_rule_6_1_1_1
  tags:
    - rule_6_1_1
    - server_l1
    - workstation_l1

- name: "SECTION6 | 6.1.1.2 | Ensure journald log file access is configured"
  when:
    - cis_ubuntu2404_rule_6_1_1_2
  tags:
    - rule_6_1_1
    - server_l1
    - workstation_l1
  block:
    - name: "SECTION6 | 6.1.1.2 | Ensure journald log file access is configured | configure access"
      ansible.builtin.file:
        path: "{{ item.path }}"
        owner: root
        group: root
        mode: "{{ item.mode }}"
      with_items:
        - path: /run/user
          mode: "0755"
        - path: /run/systemd/ask-password
          mode: "0755"
        - path: /run/systemd/seats
          mode: "0755"
        - path: /run/systemd/sessions
          mode: "0755"
        - path: /run/systemd/users
          mode: "0755"
        - path: /run/systemd/machines
          mode: "0755"
        - path: /run/systemd/shutdown
          mode: "0755"
        - path: /run/log
          mode: "0755"

        - path: /var/lib/systemd
          mode: "0755"
        - path: /var/lib/systemd/coredump
          mode: "0755"
        - path: /var/lib/systemd/ephemeral-trees
          mode: "0755"
        - path: /var/lib/private
          mode: "0700"

        - path: /var/log/private
          mode: "0700"
        - path: /var/cache/private
          mode: "0700"
    - name: "SECTION6 | 6.1.1.2 | Ensure journald log file access is configured | gather information"
      ansible.builtin.shell: |
        set -o pipefail
        {
          a_output=() a_output2=()
          l_systemd_config_file="/etc/tmpfiles.d/systemd.conf" l_analyze_cmd="$(readlink -f /bin/systemd-analyze)"
          f_file_chk()
          {
              l_maxperm="$( printf '%o' $(( 0777 & ~$l_perm_mask )) )"
              if [ $(( $l_mode & $l_perm_mask )) -le 0 ] || [[ "$l_type" = "Directory" && "$l_mode" =~ 275(0|5) ]]; then
                a_out+=("  - $l_type \"$l_logfile\" access is:" \
                "    mode: \"$l_mode\", owned by: \"$l_user\", and group owned by: \"$l_group\"")
              else
                a_out2+=("  - $l_type \"$l_logfile\" access is:" \
                "    mode: \"$l_mode\", owned by: \"$l_user\", and group owned by: \"$l_group\"" \
                "    should be mode: \"$l_maxperm\" or more restrictive")
              fi
          }
          while IFS= read -r l_file; do
              l_file="$(tr -d '# ' <<< "$l_file")" a_out=() a_out2=()
              l_logfile_perms_line="$(awk '($1~/^(f|d)$/ && $2~/^\// && $3~/[0-9]{3,}/){print $2 ":" $3 ":" $4 ":" $5}' "$l_file")"
              while IFS=: read -r l_logfile l_mode l_user l_group; do
                if [ -d "$l_logfile" ]; then
                    l_perm_mask="0027" l_type="Directory"
                    grep -Psq '^(\/run|\/var\/lib\/systemd)\b' <<< "$l_logfile" && l_perm_mask="0022"
                else
                    l_perm_mask="0137" l_type="File"
                fi
                grep -Psq '^(\/run|\/var\/lib\/systemd)\b' <<< "$l_logfile" && l_perm_mask="0022"
                f_file_chk
              done <<< "$l_logfile_perms_line"
              [ "${{ '{' }}#a_out[@]{{ '}' }}" -gt "0" ] && a_output+=(" - File: \"$l_file\" sets:" "${{ '{' }}a_out[@]{{ '}' }}")
              [ "${{ '{' }}#a_out2[@]{{ '}' }}" -gt "0" ] && a_output2+=(" - File: \"$l_file\" sets:" "${{ '{' }}a_out2[@]{{ '}' }}")
          done < <($l_analyze_cmd cat-config "$l_systemd_config_file" | tac | grep -Pio '^\h*#\h*\/[^#\n\r\h]+\.conf\b')
          if [ "${{ '{' }}#a_output2[@]{{ '}' }}" -le 0 ]; then
              printf '%s\n' "" "- Audit Result:" "  ** PASS **" "${{ '{' }}a_output[@]{{ '}' }}" ""
          else
              printf '%s\n' "" "- Audit Result:" "  ** REVIEW **" \
              " -  Review file access to ensure they are set IAW site policy:" "${{ '{' }}a_output2[@]{{ '}' }}"
              [ "${{ '{' }}#a_output[@]{{ '}' }}" -gt 0 ] && printf '%s\n' "" "- Correctly set:" "${{ '{' }}a_output[@]{{ '}' }}" ""
          fi
        }
      args:
        executable: "{{ cis_ubuntu2404_shell_executable }}"
      register: cis_ubuntu2404_journald_log_file_access
      changed_when: false
      failed_when: false
      check_mode: false
    - name: "SECTION6 | 6.1.1.2 | Ensure journald log file access is configured | print info"
      ansible.builtin.debug:
        msg: |
          #############################################################################################
          verify:
          - systemd-journald logfiles are mode 0640 or more restrictive
          - Directories /run/ and /var/lib/systemd/ are mode 0755 or more restrictive
          - All other configured directories are mode 2755, 0750, or more restrictive
          #############################################################################################
          {{ cis_ubuntu2404_journald_log_file_access.stdout_lines | join(cis_ubuntu2404_print_info_join_by) }}
          #############################################################################################
      when:
        - cis_ubuntu2404_journald_log_file_access.stdout_lines is defined
        - cis_ubuntu2404_journald_log_file_access.stdout_lines | length > 0

- name: "SECTION6 | 6.1.1.3 | Ensure journald log file rotation is configured"
  ansible.builtin.lineinfile:
    dest: /etc/systemd/journald.conf
    regexp: "{{ item.reg }}"
    line: "{{ item.line }}"
    state: present
    create: true
    owner: root
    group: root
    mode: "0640"
  with_items:
    - reg: "{{ cis_ubuntu2404_regex_base_search }}SystemMaxUse{{ cis_ubuntu2404_regex_base_search_equals }}"
      line: "SystemMaxUse={{ cis_ubuntu2404_journald_system_max_use }}"
    - reg: "{{ cis_ubuntu2404_regex_base_search }}SystemKeepFree{{ cis_ubuntu2404_regex_base_search_equals }}"
      line: "SystemKeepFree={{ cis_ubuntu2404_journald_system_keep_free }}"
    - reg: "{{ cis_ubuntu2404_regex_base_search }}RuntimeMaxUse{{ cis_ubuntu2404_regex_base_search_equals }}"
      line: "RuntimeMaxUse={{ cis_ubuntu2404_journald_runtime_max_use }}"
    - reg: "{{ cis_ubuntu2404_regex_base_search }}RuntimeKeepFree{{ cis_ubuntu2404_regex_base_search_equals }}"
      line: "RuntimeKeepFree={{ cis_ubuntu2404_journald_runtime_keep_free }}"
    - reg: "{{ cis_ubuntu2404_regex_base_search }}MaxFileSec{{ cis_ubuntu2404_regex_base_search_equals }}"
      line: "MaxFileSec={{ cis_ubuntu2404_journald_max_file_sec }}"
  notify: Restart systemd-journald
  when:
    - cis_ubuntu2404_rule_6_1_1_3
  tags:
    - rule_6_1_1
    - server_l1
    - workstation_l1

# NOTE: not implemented as it will verified implicit by choose on 'cis_ubuntu2404_preferred_capturing_log_method'
# - name: "SECTION6 | 6.1.1.4 | Ensure only one logging system is in use"
#   when:
#     - cis_ubuntu2404_rule_6_1_1_4
#   tags:
#     - rule_6_1_1
#     - server_l1
#     - workstation_l1

# ------------------------------------------------------------------------------

- name: "SECTION6 | 6.1.2.1.1 | Ensure systemd-journal-remote is installed"
  ansible.builtin.apt:
    name: systemd-journal-remote
    state: present
    force_apt_get: true
  when:
    - cis_ubuntu2404_rule_6_1_2_1_1
    - cis_ubuntu2404_set_journal_upload | bool
    - cis_ubuntu2404_preferred_capturing_log_method == "journald"
  tags:
    - rule_6_1_2_1
    - server_l1
    - workstation_l1

- name: "SECTION6 | 6.1.2.1.2 | Ensure systemd-journal-upload authentication is configured"
  ansible.builtin.lineinfile:
    dest: /etc/systemd/journal-upload.conf
    regexp: "{{ item.reg }}"
    line: "{{ item.line }}"
    state: present
    create: true
    owner: root
    group: root
    mode: "0640"
    insertafter: "{{ item.insertafter }}"
  with_items:
    - reg: '\[Upload\]'
      line: "[Upload]"
      insertafter: "EOF"
    - reg: "{{ cis_ubuntu2404_regex_base_search }}URL{{ cis_ubuntu2404_regex_base_search_equals }}"
      line: "URL={{ cis_ubuntu2404_set_journal_upload_url }}"
      insertafter: '\[Upload\]'
    - reg: "{{ cis_ubuntu2404_regex_base_search }}ServerKeyFile{{ cis_ubuntu2404_regex_base_search_equals }}"
      line: "ServerKeyFile={{ cis_ubuntu2404_set_journal_upload_server_key_file }}"
      insertafter: '\[Upload\]'
    - reg: "{{ cis_ubuntu2404_regex_base_search }}ServerCertificateFile{{ cis_ubuntu2404_regex_base_search_equals }}"
      line: "ServerCertificateFile={{ cis_ubuntu2404_set_journal_upload_server_certificate_file }}"
      insertafter: '\[Upload\]'
    - reg: "{{ cis_ubuntu2404_regex_base_search }}TrustedCertificateFile{{ cis_ubuntu2404_regex_base_search_equals }}"
      line: "TrustedCertificateFile={{ cis_ubuntu2404_set_journal_upload_trusted_certificate_file }}"
      insertafter: '\[Upload\]'
  notify: Restart systemd-journal-upload
  when:
    - cis_ubuntu2404_rule_6_1_2_1_2
    - cis_ubuntu2404_set_journal_upload | bool
    - cis_ubuntu2404_set_journal_upload_url is defined
    - cis_ubuntu2404_set_journal_upload_url is not none
    - cis_ubuntu2404_preferred_capturing_log_method == "journald"
  tags:
    - rule_6_1_2_1
    - server_l1
    - workstation_l1

## NOTE: done in step before, by call notify
# - name: "SECTION6 | 6.1.2.1.3 | Ensure systemd-journal-upload is enabled and active"

- name: "SECTION6 | 6.1.2.1.4 | Ensure systemd-journal-remote service is not in use"
  when:
    - cis_ubuntu2404_rule_6_1_2_1_4
    - not cis_ubuntu2404_set_journal_upload | bool
    - cis_ubuntu2404_preferred_capturing_log_method == "journald"
  tags:
    - rule_6_1_2_1
    - server_l1
    - workstation_l1
  block:
    - name: "SECTION6 | 6.1.2.1.4 | Ensure systemd-journal-remote service is not in use | check service available"
      ansible.builtin.shell: >
        set -o pipefail &&
        systemctl show systemd-journal-remote.service | grep -E 'LoadState|ActiveState' | cut -d = -f 2 | tr -d '\n'
      args:
        executable: "{{ cis_ubuntu2404_shell_executable }}"
      register: service_status_systemd_journal_remote
      changed_when: false
      check_mode: false
    - name: "SECTION6 | 6.1.2.1.4 | Ensure systemd-journal-remote service is not in use | disable services"
      ansible.builtin.systemd_service:
        name: "{{ item }}"
        daemon_reload: true
        enabled: false
        masked: true
        state: stopped
      with_items:
        - systemd-journal-remote.socket
        - systemd-journal-remote.service
      when:
        - service_status_systemd_journal_remote.stdout in ('loadedactive','loadedinactive')

# ------------------------------------------------------------------------------

- name: "SECTION6 | 6.1.2.2 | Ensure journald ForwardToSyslog is disabled"
  ansible.builtin.lineinfile:
    dest: /etc/systemd/journald.conf
    regexp: "{{ cis_ubuntu2404_regex_base_search }}ForwardToSyslog{{ cis_ubuntu2404_regex_base_search_equals }}"
    line: "ForwardToSyslog=no"
    state: present
    owner: root
    group: root
    mode: "0640"
  notify: Restart systemd-journald
  when:
    - cis_ubuntu2404_rule_6_1_2_2
    - cis_ubuntu2404_preferred_capturing_log_method == "journald"
  tags:
    - rule_6_1_2
    - server_l1
    - workstation_l1

- name: "SECTION6 | 6.1.2.3 | Ensure journald Compress is configured"
  ansible.builtin.lineinfile:
    dest: /etc/systemd/journald.conf
    regexp: "{{ cis_ubuntu2404_regex_base_search }}Compress{{ cis_ubuntu2404_regex_base_search_equals }}"
    line: "Compress=yes"
    state: present
    create: true
    owner: root
    group: root
    mode: "0640"
  notify: Restart systemd-journald
  when:
    - cis_ubuntu2404_rule_6_1_2_3
    - cis_ubuntu2404_preferred_capturing_log_method == "journald"
  tags:
    - rule_6_1_2
    - server_l1
    - workstation_l1

- name: "SECTION6 | 6.1.2.4 | Ensure journald Storage is configured"
  ansible.builtin.lineinfile:
    dest: /etc/systemd/journald.conf
    regexp: "{{ cis_ubuntu2404_regex_base_search }}Storage{{ cis_ubuntu2404_regex_base_search_equals }}"
    line: "Storage=persistent"
    state: present
    create: true
    owner: root
    group: root
    mode: "0640"
  notify: Restart systemd-journald
  when:
    - cis_ubuntu2404_rule_6_1_2_4
    - cis_ubuntu2404_preferred_capturing_log_method == "journald"
  tags:
    - rule_6_1_2
    - server_l1
    - workstation_l1

# ------------------------------------------------------------------------------

- name: "SECTION6 | 6.1.3.1 | Ensure rsyslog is installed"
  ansible.builtin.apt:
    name: rsyslog
    state: present
    force_apt_get: true
  when:
    - cis_ubuntu2404_rule_6_1_3_1
    - cis_ubuntu2404_preferred_capturing_log_method == "rsyslog"
  tags:
    - rule_6_1_3
    - server_l1
    - workstation_l1

- name: "SECTION6 | 6.1.3.2 | Ensure rsyslog service is enabled and active"
  ansible.builtin.systemd:
    name: rsyslog
    daemon_reload: true
    enabled: true
    masked: false
    state: started
  when:
    - cis_ubuntu2404_rule_6_1_3_2
    - cis_ubuntu2404_preferred_capturing_log_method == "rsyslog"
  tags:
    - rule_6_1_3
    - server_l1
    - workstation_l1

- name: "SECTION6 | 6.1.3.3 | Ensure journald is configured to send logs to rsyslog"
  ansible.builtin.lineinfile:
    dest: /etc/systemd/journald.conf
    regexp: "{{ cis_ubuntu2404_regex_base_search }}ForwardToSyslog{{ cis_ubuntu2404_regex_base_search_equals }}"
    line: "ForwardToSyslog=yes"
    state: present
    create: true
    owner: root
    group: root
    mode: "0644"
  notify: Restart systemd-journald
  when:
    - cis_ubuntu2404_rule_6_1_3_3
    - cis_ubuntu2404_preferred_capturing_log_method == "rsyslog"
  tags:
    - rule_6_1_3
    - server_l1
    - workstation_l1

- name: "SECTION6 | 6.1.3.4 | Ensure rsyslog log file creation mode is configured"
  ansible.builtin.lineinfile:
    dest: /etc/rsyslog.conf
    regexp: "{{ cis_ubuntu2404_regex_base_search }}$FileCreateMode "
    line: "$FileCreateMode 0640"
    state: present
    create: true
    owner: root
    group: root
    mode: "0644"
  notify: Restart rsyslog
  when:
    - cis_ubuntu2404_rule_6_1_3_4
    - cis_ubuntu2404_preferred_capturing_log_method == "rsyslog"
  tags:
    - rule_6_1_3
    - server_l1
    - workstation_l1

- name: "SECTION6 | 6.1.3.5 | Ensure rsyslog logging is configured"
  ansible.builtin.template:
    src: 60-rsyslog.conf.j2
    dest: /etc/rsyslog.d/60-rsyslog.conf
    owner: root
    group: root
    mode: "0644"
  notify: Restart rsyslog
  when:
    - cis_ubuntu2404_rule_6_1_3_5
    - cis_ubuntu2404_preferred_capturing_log_method == "rsyslog"
  tags:
    - rule_6_1_3
    - server_l1
    - workstation_l1

- name: "SECTION6 | 6.1.3.6 | Ensure rsyslog is configured to send logs to a remote log host"
  ansible.builtin.template:
    src: 60-rsyslog.conf.j2
    dest: /etc/rsyslog.d/60-rsyslog.conf
    owner: root
    group: root
    mode: "0644"
  notify: Restart rsyslog
  when:
    - cis_ubuntu2404_rule_6_1_3_6
    - cis_ubuntu2404_set_rsyslog_remote | bool
    - cis_ubuntu2404_preferred_capturing_log_method == "rsyslog"
  tags:
    - rule_6_1_3
    - server_l1
    - workstation_l1

- name: "SECTION6 | 6.1.3.7 | Ensure rsyslog is not configured to receive logs from a remote client"
  ansible.builtin.lineinfile:
    dest: /etc/rsyslog.conf
    regexp: "{{ item.reg }}"
    line: "{{ item.line }}"
    state: present
    create: true
    owner: root
    group: root
    mode: "0644"
  with_items:
    - reg: '^module\(load="imtcp"\)'
      line: '#module(load="imtcp")'
    - reg: '^input\(type="imtcp" port="514"\)'
      line: '#input(type="imtcp" port="514")'
  notify: Restart rsyslog
  when:
    - cis_ubuntu2404_rule_6_1_3_7
    - cis_ubuntu2404_preferred_capturing_log_method == "rsyslog"
  tags:
    - rule_6_1_3
    - server_l1
    - workstation_l1

- name: "SECTION6 | 6.1.3.8 | Ensure logrotate is configured"
  ansible.builtin.template:
    src: logrotate.conf.j2
    dest: /etc/logrotate.conf
    owner: root
    group: root
    mode: "0644"
  notify: Restart rsyslog
  when:
    - cis_ubuntu2404_rule_6_1_3_8
    - cis_ubuntu2404_preferred_capturing_log_method == "rsyslog"
  tags:
    - rule_6_1_3
    - server_l1
    - workstation_l1

# ------------------------------------------------------------------------------

- name: "SECTION6 | 6.1.4.1 | Ensure access to all logfiles has been configured"
  when:
    - cis_ubuntu2404_rule_6_1_4_1
  tags:
    - rule_6_1_4
    - server_l1
    - workstation_l1
    - molecule-idempotence-notest
  block:
    - name: "SECTION6 | 6.1.4.1 | Ensure access to all logfiles has been configured | find all files under '/var/log/'"
      ansible.builtin.find:
        paths: /var/log/
        file_type: file
        recurse: true
      register: cis_ubuntu2404_logfiles
    - name: "SECTION6 | 6.1.4.1 | Ensure access to all logfiles has been configured | set logfile access"
      ansible.builtin.file:
        dest: "{{ item.path }}"
        state: file
        owner: "{{ logfiles_item_owner | default('root') }}"
        group: "{{ logfiles_item_group | default('adm') }}"
        mode: "{{ logfiles_item_mode | default('0640') }}"
      loop: "{{ cis_ubuntu2404_logfiles.files }}"
      loop_control:
        label: "{{ item.path }}"
      vars:
        logfiles_item_owner: "{{ cis_ubuntu2404_logfiles_access | selectattr('files', 'search', item.path | basename) | map(attribute='owner') | first }}"
        logfiles_item_group: "{{ cis_ubuntu2404_logfiles_access | selectattr('files', 'search', item.path | basename) | map(attribute='group') | first }}"
        logfiles_item_mode: "{{ cis_ubuntu2404_logfiles_access | selectattr('files', 'search', item.path | basename) | map(attribute='mode') | first }}"

# ------------------------------------------------------------------------------

- name: "SECTION6 | 6.2.1.1 | Ensure auditd packages are installed"
  ansible.builtin.apt:
    name:
      - auditd
      - audispd-plugins
    state: present
    force_apt_get: true
  when:
    - cis_ubuntu2404_rule_6_2_1_1
  tags:
    - rule_6_2_1
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.1.2 | Ensure auditd service is enabled and active"
  ansible.builtin.systemd_service:
    name: auditd
    daemon_reload: true
    enabled: true
    masked: false
    state: started
  when:
    - cis_ubuntu2404_rule_6_2_1_2
    - ansible_virtualization_type != "docker"
  tags:
    - rule_6_2_1
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.1.3 | Ensure auditing for processes that start prior to auditd is enabled"
  when:
    - cis_ubuntu2404_rule_6_2_1_3
  tags:
    - rule_6_2_1
    - server_l2
    - workstation_l2
  block:
    - name: "SECTION6 | 6.2.1.3 | Ensure auditing for processes that start prior to auditd is enabled | grub add"
      ansible.builtin.replace:
        path: "{{ cis_ubuntu2404_default_grub_file }}"
        regexp: '^(GRUB_CMDLINE_LINUX=\"(?!.*audit=)[^\"]*)(\".*)'
        replace: '\1 audit=1\2'
      notify: Update-grub
    - name: "SECTION6 | 6.2.1.3 | Ensure auditing for processes that start prior to auditd is enabled | grub replace"
      ansible.builtin.replace:
        path: "{{ cis_ubuntu2404_default_grub_file }}"
        regexp: "audit=0"
        replace: "audit=1"
      notify: Update-grub

- name: "SECTION6 | 6.2.1.4 | Ensure audit_backlog_limit is sufficient"
  when:
    - cis_ubuntu2404_rule_6_2_1_4
  tags:
    - rule_6_2_1
    - server_l2
    - workstation_l2
  block:
    - name: "SECTION6 | 6.2.1.4 | Ensure audit_backlog_limit is sufficient | grub add"
      ansible.builtin.replace:
        path: "{{ cis_ubuntu2404_default_grub_file }}"
        regexp: '^(GRUB_CMDLINE_LINUX=\"(?!.*audit_backlog_limit=)[^\"]*)(\".*)'
        replace: '\1 audit_backlog_limit={{ cis_ubuntu2404_audit_backlog_limit }}\2'
      notify: Update-grub
    - name: "SECTION6 | 6.2.1.4 | Ensure audit_backlog_limit is sufficient | grub replace"
      ansible.builtin.replace:
        path: "{{ cis_ubuntu2404_default_grub_file }}"
        regexp: 'audit_backlog_limit=\d+'
        replace: "audit_backlog_limit={{ cis_ubuntu2404_audit_backlog_limit }}"
      notify: Update-grub

# ------------------------------------------------------------------------------

- name: "SECTION6 | 6.2.2.1 | Ensure audit log storage size is configured"
  ansible.builtin.lineinfile:
    dest: /etc/audit/auditd.conf
    regexp: "{{ cis_ubuntu2404_regex_base_search }}max_log_file{{ cis_ubuntu2404_regex_base_search_equals }}"
    line: "max_log_file = {{ cis_ubuntu2404_audit_max_log_file }}"
    state: present
    create: true
    owner: root
    group: root
    mode: "0640"
  notify: Restart auditd
  when:
    - cis_ubuntu2404_rule_6_2_2_1
  tags:
    - rule_6_2_2
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.2.2 | Ensure audit logs are not automatically deleted"
  ansible.builtin.lineinfile:
    dest: /etc/audit/auditd.conf
    regexp: "{{ cis_ubuntu2404_regex_base_search }}max_log_file_action{{ cis_ubuntu2404_regex_base_search_equals }}"
    line: "max_log_file_action = {{ cis_ubuntu2404_audit_max_log_file_action }}"
    state: present
    create: true
    owner: root
    group: root
    mode: "0640"
  notify: Restart auditd
  when:
    - cis_ubuntu2404_rule_6_2_2_2
  tags:
    - rule_6_2_2
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.2.3 | Ensure system is disabled when audit logs are full"
  ansible.builtin.lineinfile:
    dest: /etc/audit/auditd.conf
    regexp: "{{ item.reg }}"
    line: "{{ item.line }}"
    state: present
    create: true
    owner: root
    group: root
    mode: "0640"
  with_items:
    - reg: "{{ cis_ubuntu2404_regex_base_search }}disk_full_action{{ cis_ubuntu2404_regex_base_search_equals }}"
      line: "disk_full_action = {{ cis_ubuntu2404_audit_disk_full_action }}"
    - reg: "{{ cis_ubuntu2404_regex_base_search }}disk_error_action{{ cis_ubuntu2404_regex_base_search_equals }}"
      line: "disk_error_action = {{ cis_ubuntu2404_audit_disk_error_action }}"
  notify: Restart auditd
  when:
    - cis_ubuntu2404_rule_6_2_2_3
  tags:
    - rule_6_2_2
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.2.4 | Ensure system warns when audit logs are low on space"
  ansible.builtin.lineinfile:
    dest: /etc/audit/auditd.conf
    regexp: "{{ item.reg }}"
    line: "{{ item.line }}"
    state: present
    create: true
    owner: root
    group: root
    mode: "0640"
  with_items:
    - reg: "{{ cis_ubuntu2404_regex_base_search }}space_left_action{{ cis_ubuntu2404_regex_base_search_equals }}"
      line: "space_left_action = {{ cis_ubuntu2404_audit_space_left_action }}"
    - reg: "{{ cis_ubuntu2404_regex_base_search }}admin_space_left_action{{ cis_ubuntu2404_regex_base_search_equals }}"
      line: "admin_space_left_action = {{ cis_ubuntu2404_audit_admin_space_left_action }}"
  notify: Restart auditd
  when:
    - cis_ubuntu2404_rule_6_2_2_4
  tags:
    - rule_6_2_2
    - server_l2
    - workstation_l2

# ------------------------------------------------------------------------------

- name: "SECTION6 | 6.2.3.1 | Ensure changes to system administration scope (sudoers) is collected"
  ansible.builtin.template:
    src: audit/cis_6_2_3_1.rules.j2
    dest: /etc/audit/rules.d/cis_6_2_3_1.rules
    owner: root
    group: root
    mode: "0640"
  notify: Load audit rules
  when:
    - cis_ubuntu2404_rule_6_2_3_1
  tags:
    - rule_6_2_3
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.3.2 | Ensure actions as another user are always logged"
  ansible.builtin.template:
    src: audit/cis_6_2_3_2.rules.j2
    dest: /etc/audit/rules.d/cis_6_2_3_2.rules
    owner: root
    group: root
    mode: "0640"
  notify: Load audit rules
  when:
    - cis_ubuntu2404_rule_6_2_3_2
  tags:
    - rule_6_2_3
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.3.3 | Ensure events that modify the sudo log file are collected"
  ansible.builtin.template:
    src: audit/cis_6_2_3_3.rules.j2
    dest: /etc/audit/rules.d/cis_6_2_3_3.rules
    owner: root
    group: root
    mode: "0640"
  notify: Load audit rules
  when:
    - cis_ubuntu2404_rule_6_2_3_3
  tags:
    - rule_6_2_3
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.3.4 | Ensure events that modify date and time information are collected"
  ansible.builtin.template:
    src: audit/cis_6_2_3_4.rules.j2
    dest: /etc/audit/rules.d/cis_6_2_3_4.rules
    owner: root
    group: root
    mode: "0640"
  notify: Load audit rules
  when:
    - cis_ubuntu2404_rule_6_2_3_4
  tags:
    - rule_6_2_3
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.3.5 | Ensure events that modify the system's network environment are collected"
  ansible.builtin.template:
    src: audit/cis_6_2_3_5.rules.j2
    dest: /etc/audit/rules.d/cis_6_2_3_5.rules
    owner: root
    group: root
    mode: "0640"
  notify: Load audit rules
  when:
    - cis_ubuntu2404_rule_6_2_3_5
  tags:
    - rule_6_2_3
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.3.6 | Ensure use of privileged commands are collected"
  when:
    - cis_ubuntu2404_rule_6_2_3_6
  tags:
    - rule_6_2_3
    - server_l2
    - workstation_l2
    - molecule-idempotence-notest
  block:
    - name: "SECTION6 | 6.2.3.6 | Ensure use of privileged commands are collected | get list of setuid/setguid binaries"
      ansible.builtin.shell: |
        set -o pipefail
        for PARTITION in $(findmnt -n -l -k -it "$(awk '/nodev/ { print $2 }' /proc/filesystems | paste -sd,)" | grep -Pv "noexec|nosuid" | awk '{print $1}'); do
          find "${PARTITION}" -xdev -perm /6000 -type f 2>/dev/null
        done
      args:
        executable: "{{ cis_ubuntu2404_shell_executable }}"
      register: cis_ubuntu2404_audit_proc_paths
      changed_when: false
      check_mode: false
    - name: "SECTION6 | 6.2.3.6 | Ensure use of privileged commands are collected | set rule"
      ansible.builtin.template:
        src: audit/cis_6_2_3_6.rules.j2
        dest: /etc/audit/rules.d/cis_6_2_3_6.rules
        owner: root
        group: root
        mode: "0640"
      notify: Load audit rules

- name: "SECTION6 | 6.2.3.7 | Ensure unsuccessful file access attempts are collected"
  ansible.builtin.template:
    src: audit/cis_6_2_3_7.rules.j2
    dest: /etc/audit/rules.d/cis_6_2_3_7.rules
    owner: root
    group: root
    mode: "0640"
  notify: Load audit rules
  when:
    - cis_ubuntu2404_rule_6_2_3_7
  tags:
    - rule_6_2_3
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.3.8 | Ensure events that modify user/group information are collected"
  ansible.builtin.template:
    src: audit/cis_6_2_3_8.rules.j2
    dest: /etc/audit/rules.d/cis_6_2_3_8.rules
    owner: root
    group: root
    mode: "0640"
  notify: Load audit rules
  when:
    - cis_ubuntu2404_rule_6_2_3_8
  tags:
    - rule_6_2_3
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.3.9 | Ensure discretionary access control permission modification events are collected"
  ansible.builtin.template:
    src: audit/cis_6_2_3_9.rules.j2
    dest: /etc/audit/rules.d/cis_6_2_3_9.rules
    owner: root
    group: root
    mode: "0640"
  notify: Load audit rules
  when:
    - cis_ubuntu2404_rule_6_2_3_9
  tags:
    - rule_6_2_3
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.3.10 | Ensure successful file system mounts are collected"
  ansible.builtin.template:
    src: audit/cis_6_2_3_10.rules.j2
    dest: /etc/audit/rules.d/cis_6_2_3_10.rules
    owner: root
    group: root
    mode: "0640"
  notify: Load audit rules
  when:
    - cis_ubuntu2404_rule_6_2_3_10
  tags:
    - rule_6_2_3
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.3.11 | Ensure session initiation information is collected"
  ansible.builtin.template:
    src: audit/cis_6_2_3_11.rules.j2
    dest: /etc/audit/rules.d/cis_6_2_3_11.rules
    owner: root
    group: root
    mode: "0640"
  notify: Load audit rules
  when:
    - cis_ubuntu2404_rule_6_2_3_11
  tags:
    - rule_6_2_3
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.3.12 | Ensure login and logout events are collected"
  ansible.builtin.template:
    src: audit/cis_6_2_3_12.rules.j2
    dest: /etc/audit/rules.d/cis_6_2_3_12.rules
    owner: root
    group: root
    mode: "0640"
  notify: Load audit rules
  when:
    - cis_ubuntu2404_rule_6_2_3_12
  tags:
    - rule_6_2_3
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.3.13 | Ensure file deletion events by users are collected"
  ansible.builtin.template:
    src: audit/cis_6_2_3_13.rules.j2
    dest: /etc/audit/rules.d/cis_6_2_3_13.rules
    owner: root
    group: root
    mode: "0640"
  notify: Load audit rules
  when:
    - cis_ubuntu2404_rule_6_2_3_13
  tags:
    - rule_6_2_3
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.3.14 | Ensure events that modify the system's Mandatory Access Controls are collected"
  ansible.builtin.template:
    src: audit/cis_6_2_3_14.rules.j2
    dest: /etc/audit/rules.d/cis_6_2_3_14.rules
    owner: root
    group: root
    mode: "0640"
  notify: Load audit rules
  when:
    - cis_ubuntu2404_rule_6_2_3_14
  tags:
    - rule_6_2_3
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.3.15 | Ensure successful and unsuccessful attempts to use the chcon command are recorded"
  ansible.builtin.template:
    src: audit/cis_6_2_3_15.rules.j2
    dest: /etc/audit/rules.d/cis_6_2_3_15.rules
    owner: root
    group: root
    mode: "0640"
  notify: Load audit rules
  when:
    - cis_ubuntu2404_rule_6_2_3_15
  tags:
    - rule_6_2_3
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.3.16 | Ensure successful and unsuccessful attempts to use the setfacl command are recorded"
  ansible.builtin.template:
    src: audit/cis_6_2_3_16.rules.j2
    dest: /etc/audit/rules.d/cis_6_2_3_16.rules
    owner: root
    group: root
    mode: "0640"
  notify: Load audit rules
  when:
    - cis_ubuntu2404_rule_6_2_3_16
  tags:
    - rule_6_2_3
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.3.17 | Ensure successful and unsuccessful attempts to use the chacl command are recorded"
  ansible.builtin.template:
    src: audit/cis_6_2_3_17.rules.j2
    dest: /etc/audit/rules.d/cis_6_2_3_17.rules
    owner: root
    group: root
    mode: "0640"
  notify: Load audit rules
  when:
    - cis_ubuntu2404_rule_6_2_3_17
  tags:
    - rule_6_2_3
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.3.18 | Ensure successful and unsuccessful attempts to use the usermod command are recorded"
  ansible.builtin.template:
    src: audit/cis_6_2_3_18.rules.j2
    dest: /etc/audit/rules.d/cis_6_2_3_18.rules
    owner: root
    group: root
    mode: "0640"
  notify: Load audit rules
  when:
    - cis_ubuntu2404_rule_6_2_3_18
  tags:
    - rule_6_2_3
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.3.19 | Ensure kernel module loading unloading and modification is collected"
  ansible.builtin.template:
    src: audit/cis_6_2_3_19.rules.j2
    dest: /etc/audit/rules.d/cis_6_2_3_19.rules
    owner: root
    group: root
    mode: "0640"
  notify: Load audit rules
  when:
    - cis_ubuntu2404_rule_6_2_3_19
  tags:
    - rule_6_2_3
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.3.20 | Ensure the audit configuration is immutable"
  ansible.builtin.template:
    src: audit/cis_6_2_3_20.rules.j2
    dest: /etc/audit/rules.d/cis_6_2_3_20.rules
    owner: root
    group: root
    mode: "0640"
  notify: Load audit rules
  when:
    - cis_ubuntu2404_rule_6_2_3_20
  tags:
    - rule_6_2_3
    - server_l2
    - workstation_l2

## NOTE: done in steps before, by call notify
# - name: "SECTION6 | 6.2.3.21 | Ensure the running and on disk configuration is the same"

# ------------------------------------------------------------------------------

- name: "SECTION6 | 6.2.4.0 | Ensure audit log_file is configured"
  ansible.builtin.lineinfile:
    dest: /etc/audit/auditd.conf
    regexp: "{{ item.reg }}"
    line: "{{ item.line }}"
    state: present
    create: true
    owner: root
    group: root
    mode: "0640"
  with_items:
    - reg: "{{ cis_ubuntu2404_regex_base_search }}log_file{{ cis_ubuntu2404_regex_base_search_equals }}"
      line: "log_file = {{ cis_ubuntu2404_audit_log_path }}/audit.log"
  notify: Restart auditd
  when:
    - cis_ubuntu2404_rule_6_2_4_0
  tags:
    - rule_6_2_4
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.4.1 | Ensure audit log files mode is configured"
  ansible.builtin.file:
    path: "{{ cis_ubuntu2404_audit_log_path }}"
    state: directory
    mode: "0640"
  when:
    - cis_ubuntu2404_rule_6_2_4_1
  tags:
    - rule_6_2_4
    - server_l2
    - workstation_l2
    - molecule-idempotence-notest

- name: "SECTION6 | 6.2.4.2 | Ensure audit log files owner is configured"
  ansible.builtin.file:
    path: "{{ cis_ubuntu2404_audit_log_path }}"
    state: directory
    owner: root
    mode: "0640"
  when:
    - cis_ubuntu2404_rule_6_2_4_2
  tags:
    - rule_6_2_4
    - server_l2
    - workstation_l2
    - molecule-idempotence-notest

- name: "SECTION6 | 6.2.4.3 | Ensure audit log files group owner is configured"
  when:
    - cis_ubuntu2404_rule_6_2_4_3
  tags:
    - rule_6_2_4
    - server_l2
    - workstation_l2
    - molecule-idempotence-notest
  block:
    - name: "SECTION6 | 6.2.4.3 | Ensure audit log files group owner is configured | auditd.conf log_group"
      ansible.builtin.lineinfile:
        dest: /etc/audit/auditd.conf
        regexp: "{{ cis_ubuntu2404_regex_base_search }}log_group{{ cis_ubuntu2404_regex_base_search_equals }}"
        line: "log_group = {{ cis_ubuntu2404_audit_log_group }}"
        state: present
        create: true
        owner: root
        group: root
        mode: "0640"
    - name: "SECTION6 | 6.2.4.3 | Ensure audit log files group owner is configured | set folder group"
      ansible.builtin.file:
        path: "{{ cis_ubuntu2404_audit_log_path }}"
        group: "{{ cis_ubuntu2404_audit_log_group }}"
        state: directory
        mode: "0750"
    - name: "SECTION6 | 6.2.4.3 | Ensure audit log files group owner is configured | set files group"
      ansible.builtin.shell: |
        set -o pipefail
        find {{ cis_ubuntu2404_audit_log_path }} -type f \( ! -group {{ cis_ubuntu2404_audit_log_group }} -a ! -group root \) -exec chgrp {{ cis_ubuntu2404_audit_log_group }} {} +
      args:
        executable: "{{ cis_ubuntu2404_shell_executable }}"
      # register: cis_ubuntu2404_audit_files_group_set
      changed_when: false
      check_mode: false

- name: "SECTION6 | 6.2.4.4 | Ensure the audit log file directory mode is configured"
  ansible.builtin.file:
    path: "{{ cis_ubuntu2404_audit_log_path }}"
    state: directory
    mode: "0750"
  when:
    - cis_ubuntu2404_rule_6_2_4_4
  tags:
    - rule_6_2_4
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.4.5 | Ensure audit configuration files mode is configured"
  when:
    - cis_ubuntu2404_rule_6_2_4_5
  tags:
    - rule_6_2_4
    - server_l2
    - workstation_l2
  block:
    - name: "SECTION6 | 6.2.4.5 | Ensure audit configuration files mode is configured | find *.conf"
      ansible.builtin.find:
        paths: /etc/audit/
        file_type: file
        patterns: "*.conf"
        recurse: true
      register: cis_ubuntu2404_audit_files_conf
    - name: "SECTION6 | 6.2.4.5 | Ensure audit configuration files mode is configured | update *.conf"
      ansible.builtin.file:
        path: "{{ item.path }}"
        mode: "0640"
      with_items: "{{ cis_ubuntu2404_audit_files_conf.files }}"
    - name: "SECTION6 | 6.2.4.5 | Ensure audit configuration files mode is configured | find *.rules"
      ansible.builtin.find:
        paths: /etc/audit/
        file_type: file
        patterns: "*.rules"
        recurse: true
      register: cis_ubuntu2404_audit_files_rules
    - name: "SECTION6 | 6.2.4.5 | Ensure audit configuration files mode is configured | update *.rules"
      ansible.builtin.file:
        path: "{{ item.path }}"
        mode: "0640"
      with_items: "{{ cis_ubuntu2404_audit_files_rules.files }}"

- name: "SECTION6 | 6.2.4.6 | Ensure audit configuration files owner is configured"
  when:
    - cis_ubuntu2404_rule_6_2_4_6
  tags:
    - rule_6_2_4
    - server_l2
    - workstation_l2
  block:
    - name: "SECTION6 | 6.2.4.6 | Ensure audit configuration files owner is configured | find *.conf"
      ansible.builtin.find:
        paths: /etc/audit/
        file_type: file
        patterns: "*.conf"
        recurse: true
      register: cis_ubuntu2404_audit_files_conf
    - name: "SECTION6 | 6.2.4.6 | Ensure audit configuration files owner is configured | update *.conf"
      ansible.builtin.file:
        path: "{{ item.path }}"
        owner: root
      with_items: "{{ cis_ubuntu2404_audit_files_conf.files }}"
    - name: "SECTION6 | 6.2.4.6 | Ensure audit configuration files owner is configured | find *.rules"
      ansible.builtin.find:
        paths: /etc/audit/
        file_type: file
        patterns: "*.rules"
        recurse: true
      register: cis_ubuntu2404_audit_files_rules
    - name: "SECTION6 | 6.2.4.6 | Ensure audit configuration files owner is configured | update *.rules"
      ansible.builtin.file:
        path: "{{ item.path }}"
        owner: root
      with_items: "{{ cis_ubuntu2404_audit_files_rules.files }}"

- name: "SECTION6 | 6.2.4.7 | Ensure audit configuration files group owner is configured"
  when:
    - cis_ubuntu2404_rule_6_2_4_7
  tags:
    - rule_6_2_4
    - server_l2
    - workstation_l2
  block:
    - name: "SECTION6 | 6.2.4.7 | Ensure audit configuration files group owner is configured | find *.conf"
      ansible.builtin.find:
        paths: /etc/audit/
        file_type: file
        patterns: "*.conf"
        recurse: true
      register: cis_ubuntu2404_audit_files_conf
    - name: "SECTION6 | 6.2.4.7 | Ensure audit configuration files group owner is configured | update *.conf"
      ansible.builtin.file:
        path: "{{ item.path }}"
        group: root
      with_items: "{{ cis_ubuntu2404_audit_files_conf.files }}"
    - name: "SECTION6 | 6.2.4.7 | Ensure audit configuration files group owner is configured | find *.rules"
      ansible.builtin.find:
        paths: /etc/audit/
        file_type: file
        patterns: "*.rules"
        recurse: true
      register: cis_ubuntu2404_audit_files_rules
    - name: "SECTION6 | 6.2.4.7 | Ensure audit configuration files group owner is configured | update *.rules"
      ansible.builtin.file:
        path: "{{ item.path }}"
        group: root
      with_items: "{{ cis_ubuntu2404_audit_files_rules.files }}"

- name: "SECTION6 | 6.2.4.8 | Ensure audit tools mode is configured"
  ansible.builtin.file:
    path: "{{ item }}"
    mode: "0755"
  loop: >
    {{
      cis_ubuntu2410_audit_tools
      if ansible_distribution_version is version_compare('24.10', '>=')
      else cis_ubuntu2404_audit_tools
      | flatten(levels=1)
    }}
  when:
    - cis_ubuntu2404_rule_6_2_4_8
  tags:
    - rule_6_2_4
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.4.9 | Ensure audit tools owner is configured"
  ansible.builtin.file:
    path: "{{ item }}"
    owner: root
  loop: >
    {{
      cis_ubuntu2410_audit_tools
      if ansible_distribution_version is version_compare('24.10', '>=')
      else cis_ubuntu2404_audit_tools
      | flatten(levels=1)
    }}
  when:
    - cis_ubuntu2404_rule_6_2_4_9
  tags:
    - rule_6_2_4
    - server_l2
    - workstation_l2

- name: "SECTION6 | 6.2.4.10 | Ensure audit tools group owner is configured"
  ansible.builtin.file:
    path: "{{ item }}"
    group: root
  loop: >
    {{
      cis_ubuntu2410_audit_tools
      if ansible_distribution_version is version_compare('24.10', '>=')
      else cis_ubuntu2404_audit_tools
      | flatten(levels=1)
    }}
  when:
    - cis_ubuntu2404_rule_6_2_4_10
  tags:
    - rule_6_2_4
    - server_l2
    - workstation_l2

# ------------------------------------------------------------------------------

- name: "SECTION6 | 6.3.1 | Ensure AIDE is installed"
  when:
    - cis_ubuntu2404_install_aide | bool
    - cis_ubuntu2404_rule_6_3_1
  tags:
    - rule_6_3
    - server_l1
    - workstation_l1
  block:
    - name: "SECTION6 | 6.3.1 | Ensure AIDE is installed | install AIDE"
      ansible.builtin.apt:
        name:
          - aide
          - aide-common
        state: present
        force_apt_get: true
    - name: "SECTION6 | 6.3.1 | Ensure AIDE is installed | stat AIDE DB"
      ansible.builtin.stat:
        path: /var/lib/aide/aide.db
      register: cis_stat_aide_db
      when:
        - cis_ubuntu2404_config_aide
    - name: "SECTION6 | 6.3.1 | Ensure AIDE is installed | init AIDE | could take time ..."
      ansible.builtin.command: /usr/sbin/aideinit
      args:
        creates: /var/lib/aide/aide.db.new
      when:
        - cis_ubuntu2404_config_aide
        - not cis_stat_aide_db.stat.exists
    - name: "SECTION6 | 6.3.1 | Ensure AIDE is installed | stat AIDE DB"
      ansible.builtin.stat:
        path: /var/lib/aide/aide.db.new
      register: cis_stat_aide_db_new
      when:
        - cis_ubuntu2404_config_aide
    - name: "SECTION6 | 6.3.1 | Ensure AIDE is installed | move new db file"
      ansible.builtin.command: mv /var/lib/aide/aide.db.new /var/lib/aide/aide.db
      changed_when: cis_stat_aide_db_new_moved.rc == 0
      check_mode: false
      register: cis_stat_aide_db_new_moved
      when:
        - cis_ubuntu2404_config_aide
        - cis_stat_aide_db_new.stat.exists

- name: "SECTION6 | 6.3.2 | Ensure filesystem integrity is regularly checked | could take time ..."
  ansible.builtin.systemd_service:
    name: "{{ item }}"
    daemon_reload: true
    enabled: true
    masked: false
    state: started
  with_items:
    - dailyaidecheck.timer
    - dailyaidecheck.service
  when:
    - cis_ubuntu2404_install_aide | bool
    - cis_ubuntu2404_config_aide | bool
    - cis_ubuntu2404_rule_6_3_2
    - ansible_virtualization_type != "docker"
  tags:
    - rule_6_3
    - server_l1
    - workstation_l1

- name: "SECTION6 | 6.3.3 | Ensure cryptographic mechanisms are used to protect the integrity of audit tools"
  ansible.builtin.lineinfile:
    dest: "{{ cis_ubuntu2404_aide_conf_file }}"
    regexp: "{{ item.reg }}"
    line: "{{ item.line }}"
    state: present
    create: true
    owner: root
    group: root
    mode: "0644"
  with_items:
    - reg: "{{ cis_ubuntu2404_regex_base_search }}.*?sbin.*?\/\/auditctl"
      line: "/usr/sbin/auditctl p+i+n+u+g+s+b+acl+xattrs+sha512"
    - reg: "{{ cis_ubuntu2404_regex_base_search }}.*?sbin.*?\/\/auditd"
      line: "/usr/sbin/auditd p+i+n+u+g+s+b+acl+xattrs+sha512"
    - reg: "{{ cis_ubuntu2404_regex_base_search }}.*?sbin.*?\/\/ausearch"
      line: "/usr/sbin/ausearch p+i+n+u+g+s+b+acl+xattrs+sha512"
    - reg: "{{ cis_ubuntu2404_regex_base_search }}.*?sbin.*?\/\/aureport"
      line: "/usr/sbin/aureport p+i+n+u+g+s+b+acl+xattrs+sha512"
    - reg: "{{ cis_ubuntu2404_regex_base_search }}.*?sbin.*?\/\/autrace"
      line: "/usr/sbin/autrace p+i+n+u+g+s+b+acl+xattrs+sha512"
    - reg: "{{ cis_ubuntu2404_regex_base_search }}.*?sbin.*?\/\/augenrules"
      line: "/usr/sbin/augenrules p+i+n+u+g+s+b+acl+xattrs+sha512"
  when:
    - cis_ubuntu2404_install_aide | bool
    - cis_ubuntu2404_config_aide | bool
    - cis_ubuntu2404_rule_6_3_3
  tags:
    - rule_6_3
    - server_l1
    - workstation_l1
